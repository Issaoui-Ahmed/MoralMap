"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[133],{2926:(e,t,s)=>{s.d(t,{hd:()=>c});var n,l,a=s(5704);let r=null!=(l=null!=(n=a.env.NEXT_PUBLIC_BASE_PATH)?n:a.env.NEXT_PUBLIC_WEBFLOW_BASE_PATH)?l:"/app",i=r&&"/"!==r?"".concat(r.startsWith("/")?"":"/").concat(r.replace(/\/$/,"")):"",o=/^[a-zA-Z][a-zA-Z0-9+.-]*:/;function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(!e)return i||"";if(o.test(e))return e;let t=e.startsWith("/")?e:"/".concat(e);return i?"".concat(i).concat(t):t}},3133:(e,t,s)=>{s.r(t),s.d(t,{default:()=>U,useConfig:()=>Z});var n=s(5155),l=s(2115),a=s(2619),r=s.n(a),i=s(63);function o(){let{config:e,setConfig:t,setDirty:s}=Z(),a="object"==typeof(null==e?void 0:e.scenarios)&&null!==e.scenarios?e.scenarios:{},r=(null==e?void 0:e.settings)||{},i=Object.keys(a).length>0?Object.keys(a).length:1,o=r.number_of_scenarios||1,c=e=>{t(t=>({...t,settings:{...null==t?void 0:t.settings,...e}})),s(!0)},d=Math.min(Math.max(o,1),i);return(0,l.useEffect)(()=>{o!==d&&c({number_of_scenarios:d})},[o,d]),(0,n.jsxs)("div",{className:"max-w-xl space-y-6",children:[(0,n.jsx)("h2",{className:"text-lg font-semibold",children:"General Settings"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("input",{id:"scenario-shuffle",type:"checkbox",className:"h-4 w-4",checked:!!r.scenario_shuffle,onChange:e=>c({scenario_shuffle:e.target.checked})}),(0,n.jsx)("label",{htmlFor:"scenario-shuffle",className:"text-sm",children:"Shuffle scenarios"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("label",{className:"block text-sm font-medium mb-1",children:["Number of scenarios: ",d]}),(0,n.jsx)("input",{type:"range",min:1,max:i,value:d,onChange:e=>c({number_of_scenarios:Number(e.target.value)}),className:"w-full"}),(0,n.jsxs)("div",{className:"flex justify-between text-xs text-gray-500",children:[(0,n.jsx)("span",{children:"1"}),(0,n.jsx)("span",{children:i})]})]})]})}var c=s(7054),d=s(8142),u=s(4755),m=s(5384),x=s(6264),h=s(5027),p=s.n(h),f=s(5078),b=s(4597),y=s(8088),v=s(6945),g=s(9750);function j(e){let{scenario:t}=e,s=(0,c.ko)(),[a,r]=(0,l.useState)([]);return(0,l.useEffect)(()=>{var e,n;if(!s||!t)return;let l=Array.isArray(null==(e=t.start)?void 0:e[0])?t.start[0]:null,a=Array.isArray(null==(n=t.end)?void 0:n[0])?t.end[0]:null;if(!l||!a||0===l[0]&&0===l[1]||0===a[0]&&0===a[1]||l[0]===a[0]&&l[1]===a[1])return;let i=[[l,a]];(Array.isArray(t.choice_list)?t.choice_list:[]).forEach(e=>{var t;let s=Array.isArray(null==(t=e.middle_point)?void 0:t[0])?e.middle_point[0]:null;s&&i.push([l,s,a])});let o=new AbortController,c=!1;return async function(){let e=i.map(e=>(0,b.K)(e,o.signal)),t=await Promise.all(e.map(e=>e.catch(()=>null)));if(c)return;r(t);let n=t.filter(Boolean).flat();if(n.length){let e=p().latLngBounds(n);s.whenReady(()=>{c||s.fitBounds(e,{padding:[20,20],maxZoom:15,animate:!1})})}}(),()=>{c=!0,o.abort(),r([])}},[s,t]),(0,n.jsx)(n.Fragment,{children:a.map((e,t)=>e&&(0,n.jsx)(d.R,{positions:e,pathOptions:{color:0===t?"#1452EE":"#BCCEFB",weight:0===t?7:5,opacity:1}},t))})}function N(e){var t,s;let{scenario:l,onChange:a=()=>{},className:r="h-64 w-full"}=e,i=Array.isArray(null==l||null==(t=l.start)?void 0:t[0])?l.start[0]:null,o=Array.isArray(null==l||null==(s=l.end)?void 0:s[0])?l.end[0]:null;if(!i||!o)return null;let c=Array.isArray(l.choice_list)?l.choice_list:[],d=(e,t)=>s=>{let{lat:n,lng:r}=s.target.getLatLng();if("start"===e){let e=Array.isArray(l.start)?[...l.start]:[];e[0]=[n,r],a({start:e})}else if("end"===e){let e=Array.isArray(l.end)?[...l.end]:[];e[0]=[n,r],a({end:e})}else"mid"===e&&a({choice_list:c.map((e,s)=>{if(s!==t)return e;let l=Array.isArray(e.middle_point)?[...e.middle_point]:[];return l[0]=[n,r],{...e,middle_point:l}})})},h=p().latLngBounds([i,o]);return(0,n.jsx)("div",{className:r,children:(0,n.jsxs)(u.W,{bounds:h,boundsOptions:{padding:[20,20],maxZoom:15},style:{height:"100%",width:"100%"},scrollWheelZoom:!1,doubleClickZoom:!1,touchZoom:!1,boxZoom:!1,keyboard:!1,zoomControl:!1,children:[(0,n.jsx)(m.e,{attribution:'\xa9 <a href="https://carto.com/">CARTO</a>',url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"}),i&&(0,n.jsx)(x.p,{position:i,draggable:!0,icon:f.A,eventHandlers:{dragend:d("start")}}),o&&(0,n.jsx)(x.p,{position:o,draggable:!0,icon:f.v,eventHandlers:{dragend:d("end")}}),c.map((e,t)=>{var s;let l=Array.isArray(null==(s=e.middle_point)?void 0:s[0])?e.middle_point[0]:null;return l&&(0,n.jsx)(x.p,{position:l,draggable:!0,eventHandlers:{dragend:d("mid",t)}},t)}),(0,n.jsx)(j,{scenario:l})]})})}function w(e){let{label:t,values:s=[],onChange:l}=e,a=Array.isArray(s)?s:[],r=(e,t,s)=>{l(a.map((n,l)=>l===e?[t,s]:n))};return(0,n.jsxs)("div",{className:"mb-3",children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:t}),a.map((e,t)=>(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("input",{type:"number",step:"any",value:e[0],onChange:s=>r(t,Number(s.target.value),e[1]),className:"w-1/2 border rounded px-2 py-1 text-sm"}),(0,n.jsx)("input",{type:"number",step:"any",value:e[1],onChange:s=>r(t,e[0],Number(s.target.value)),className:"w-1/2 border rounded px-2 py-1 text-sm"}),a.length>1&&(0,n.jsx)("button",{onClick:()=>{l(a.filter((e,s)=>s!==t))},className:"text-xs text-red-600","aria-label":"Remove coordinate",children:"✕"})]},t)),(0,n.jsx)("button",{onClick:()=>{l([...a,[0,0]])},className:"text-xs px-2 py-1 border rounded",children:"Add"})]})}function A(e){let{label:t,values:s=[],onChange:l}=e,a=Array.isArray(s)?s:[];return(0,n.jsxs)("div",{className:"mb-3",children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:t}),a.map((e,t)=>(0,n.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,n.jsx)("input",{type:"number",value:e,onChange:e=>{var s;return s=Number(e.target.value),void l(a.map((e,n)=>n===t?s:e))},className:"border rounded px-2 py-1 text-sm w-32"}),a.length>1&&(0,n.jsx)("button",{onClick:()=>l(a.filter((e,s)=>s!==t)),className:"text-xs text-red-600","aria-label":"Remove value",children:"✕"})]},t)),(0,n.jsx)("button",{onClick:()=>l([...a,0]),className:"text-xs px-2 py-1 border rounded",children:"Add"})]})}function _(e){let{route:t,onChange:s,onDelete:l,index:a}=e;return(0,n.jsxs)("div",{className:"border rounded p-3 mb-3",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsxs)("h4",{className:"text-sm font-semibold",children:["Alternative route ",a+1]}),(0,n.jsx)("button",{onClick:l,className:"text-xs text-red-600",children:"Delete"})]}),(0,n.jsx)(w,{label:"Middle points",values:t.middle_point,onChange:e=>s({middle_point:e})}),(0,n.jsx)(A,{label:"TTS",values:t.tts,onChange:e=>s({tts:e})}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("input",{type:"checkbox",checked:!!(null==t?void 0:t.preselected),onChange:e=>s({preselected:e.target.checked}),className:"h-4 w-4"}),(0,n.jsx)("label",{className:"text-xs",children:"Preselected"})]})]})}function C(e){let{scenario:t,onChange:s,name:l}=e;return(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h3",{className:"text-lg font-semibold",children:l}),(0,n.jsx)(w,{label:"Start",values:t.start,onChange:e=>s({start:e})}),(0,n.jsx)(w,{label:"End",values:t.end,onChange:e=>s({end:e})}),(0,n.jsx)(A,{label:"Default route time (min)",values:t.default_route_time,onChange:e=>s({default_route_time:e})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Value name"}),(0,n.jsx)("input",{type:"text",value:t.value_name||"",onChange:e=>s({value_name:e.target.value}),className:"border rounded px-2 py-1 text-sm w-full"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Description"}),(0,n.jsx)("textarea",{value:t.description||"",onChange:e=>s({description:e.target.value}),className:"border rounded px-2 py-1 text-sm w-full"})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("input",{type:"checkbox",checked:!!t.randomly_preselect_route,onChange:e=>s({randomly_preselect_route:e.target.checked}),className:"h-4 w-4"}),(0,n.jsx)("label",{className:"text-sm",children:"Randomly preselect route"})]}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,n.jsx)("h4",{className:"text-sm font-semibold",children:"Alternative routes"}),(0,n.jsx)("button",{onClick:()=>{var e,n;let l=Array.isArray(null==(e=t.start)?void 0:e[0])?t.start[0]:[0,0],a=Array.isArray(null==(n=t.end)?void 0:n[0])?t.end[0]:[0,0],r=[(l[0]+a[0])/2,(l[1]+a[1])/2];s({choice_list:[...t.choice_list||[],{middle_point:[r],tts:[0],preselected:!1}]})},className:"text-xs px-2 py-1 border rounded",children:"Add alternative route"})]}),Array.isArray(t.choice_list)&&t.choice_list.length>0?t.choice_list.map((e,l)=>(0,n.jsx)(_,{route:e,index:l,onChange:e=>{s({choice_list:t.choice_list.map((t,s)=>s===l?{...t,...e}:t)})},onDelete:()=>{s({choice_list:t.choice_list.filter((e,t)=>t!==l)})}},l)):(0,n.jsx)("p",{className:"text-xs text-gray-500",children:"No alternative routes defined."})]})]})}function k(){let{config:e,setConfig:t,setDirty:s}=Z(),a="object"==typeof(null==e?void 0:e.scenarios)&&null!==e.scenarios?e.scenarios:{},r=Object.keys(a),[i,c]=(0,l.useState)(r[0]||"");(0,l.useEffect)(()=>{!i&&r.length>0&&c(r[0])},[r,i]);let d=e=>{t(t=>({...t,scenarios:e})),s(!0)},u=(e,t)=>{d({...a,[e]:{...a[e],...t}})},m=a[i];return(0,n.jsxs)("div",{className:"relative h-[calc(100vh-6rem)]",children:[m&&(0,n.jsx)(N,{scenario:m,onChange:e=>u(i,e),className:"absolute inset-0 z-0"}),(0,n.jsxs)("div",{className:"absolute top-0 left-0 z-10 h-full w-[30rem] max-w-full overflow-y-auto bg-white p-4 space-y-6 shadow-md",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,n.jsx)("h2",{className:"font-semibold",children:"Scenarios"}),(0,n.jsx)("button",{onClick:()=>{let e=i?a[i]:null,t=r.length+1,s=e?{..."function"==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e)),scenario_name:"Scenario ".concat(t)}:{start:[[0,0]],end:[[0,0]],default_route_time:[0],choice_list:[],scenario_name:"Scenario ".concat(t),value_name:"",description:"",randomly_preselect_route:!1},n="scenario_".concat(t);d({...a,[n]:s}),c(n)},className:"text-xs px-2 py-1 border rounded",children:"Add"})]}),(0,n.jsx)("div",{className:"max-h-40 overflow-y-auto mb-4",children:r.map(e=>{var t,s;return(0,n.jsxs)("div",{className:"flex items-center mb-1",children:[(0,n.jsx)("button",{onClick:()=>(e=>{let{[e]:t,...s}=a;d(s),c(Object.keys(s)[0]||"")})(e),className:"text-xs text-red-600 mr-2 px-1","aria-label":"Delete ".concat((null==(t=a[e])?void 0:t.scenario_name)||e),children:"✕"}),(0,n.jsx)("button",{onClick:()=>c(e),className:"flex-1 text-left px-2 py-1 rounded text-sm ".concat(e===i?"bg-indigo-100":"hover:bg-gray-100"),children:(null==(s=a[e])?void 0:s.scenario_name)?a[e].scenario_name:e})]},e)})})]}),(0,n.jsx)(o,{}),m?(0,n.jsx)(C,{scenario:m,scenarioKey:i,onChange:e=>u(i,e)}):(0,n.jsx)("p",{className:"text-sm text-gray-500",children:"No scenarios defined."})]})]})}delete p().Icon.Default.prototype._getIconUrl,p().Icon.Default.mergeOptions({iconRetinaUrl:y.A.src||y.A,iconUrl:v.A.src||v.A,shadowUrl:g.A.src||g.A});var S=s(2926);let E=(0,S.hd)("/api/route-endpoints"),T=["text","number","email","date","select"];function O(){let[e,t]=(0,l.useState)(null),[s,a]=(0,l.useState)([]),[r,i]=(0,l.useState)(0),[o,c]=(0,l.useState)(!0),[d,u]=(0,l.useState)(!1),[m,x]=(0,l.useState)(""),[h,p]=(0,l.useState)(!0),[f,b]=(0,l.useState)(null);(0,l.useEffect)(()=>{let e=!1;return c(!0),fetch(E).then(e=>{if(!e.ok)throw Error("Failed to load config (".concat(e.status,")"));return e.json()}).then(s=>{e||(t(s),a(Array.isArray(null==s?void 0:s.survey)?s.survey.map(y):[]),i(0),x(""))}).catch(e=>x(e.message)).finally(()=>!e&&c(!1)),()=>{e=!0}},[]);let y=e=>{var t;return{name:null!=(t=null==e?void 0:e.name)?t:"question",type:T.includes(null==e?void 0:e.type)?e.type:"text",options:Array.isArray(null==e?void 0:e.options)?e.options:[]}},v=(0,l.useMemo)(()=>(function(e){let t=[],s=e.map(e=>(e.name||"").trim());s.forEach((e,s)=>{e||t.push("Field ".concat(s+1,": name is required"))});let n=new Set;return s.forEach((e,s)=>{e&&(n.has(e)&&t.push("Field ".concat(s+1,': duplicate name "').concat(e,'"')),n.add(e))}),e.forEach((e,s)=>{T.includes(e.type)||t.push("Field ".concat(s+1,": invalid type")),"select"===e.type&&0===(e.options||[]).map(e=>"".concat(e).trim()).filter(Boolean).length&&t.push("Field ".concat(s+1,": select requires at least one option"))}),{ok:0===t.length,errors:t}})(s),[s]),g=v.ok,j=(e,t)=>{a(s=>{let n=[...s],[l]=n.splice(e,1);return n.splice(t,0,l),n}),i(t)},N=(e,t)=>{a(s=>s.map((s,n)=>n===e?y({...s,...t}):s))},w=async()=>{if(e&&g){u(!0),x("");try{let n={...e,survey:s.map(P)},l=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!l.ok)throw Error("Failed to save (".concat(l.status,")"));try{let e=await fetch(E).then(e=>e.json());t(e)}catch(e){}b(new Date)}catch(e){x(e.message)}finally{u(!1)}}};return o?(0,n.jsx)("div",{className:"p-6 text-sm text-gray-600",children:"Loading…"}):(0,n.jsxs)("div",{className:"flex h-[calc(100vh-2rem)] gap-4 p-4",children:[(0,n.jsxs)("div",{className:"w-80 shrink-0 border rounded-2xl overflow-hidden flex flex-col",children:[(0,n.jsxs)("div",{className:"px-4 py-3 border-b bg-gray-50 flex items-center justify-between",children:[(0,n.jsx)("h2",{className:"font-semibold",children:"Survey fields"}),(0,n.jsx)("button",{onClick:()=>{let e={name:"question",type:"text",options:[]},t=new Set(s.map(e=>e.name)),n=1,l=e.name;for(;t.has(l);)l="".concat(e.name).concat(n++);e.name=l,a(t=>[...t,e]),i(s.length)},className:"text-sm px-2 py-1 rounded-lg border",children:"Add"})]}),(0,n.jsx)("div",{className:"flex-1 overflow-auto",children:0===s.length?(0,n.jsxs)("div",{className:"p-4 text-sm text-gray-500",children:["No fields yet. Click ",(0,n.jsx)("b",{children:"Add"}),"."]}):(0,n.jsx)("ul",{className:"divide-y",children:s.map((e,t)=>{var l;return(0,n.jsxs)("li",{className:"flex items-center justify-between px-3 py-2 cursor-pointer ".concat(r===t?"bg-indigo-50":"hover:bg-gray-50"),onClick:()=>i(t),children:[(0,n.jsxs)("div",{className:"min-w-0",children:[(0,n.jsx)("div",{className:"truncate text-sm font-medium",children:e.name}),(0,n.jsxs)("div",{className:"text-xs text-gray-500",children:[e.type,"select"===e.type&&" • ".concat((null==(l=e.options)?void 0:l.length)||0," options")]})]}),(0,n.jsxs)("div",{className:"flex items-center gap-1",children:[(0,n.jsx)("button",{className:"text-xs px-2 py-1 border rounded-lg",onClick:e=>{e.stopPropagation(),a(e=>{let s=[...e],n={...s[t]},l=new Set(s.map(e=>e.name)),a=2,r="".concat(n.name);for(;l.has(r);)r="".concat(n.name,"_").concat(a++);return n.name=r,s.splice(t+1,0,n),s}),i(t+1)},children:"Duplicate"}),(0,n.jsx)("button",{className:"text-xs px-2 py-1 border rounded-lg",onClick:e=>{e.stopPropagation(),a(e=>e.filter((e,s)=>s!==t)),i(e=>e>t?e-1:Math.max(0,Math.min(e,s.length-2)))},children:"Delete"}),(0,n.jsxs)("div",{className:"flex flex-col ml-1",children:[(0,n.jsx)("button",{className:"text-xs border rounded-t px-2",disabled:0===t,onClick:e=>{e.stopPropagation(),j(t,t-1)},children:"▲"}),(0,n.jsx)("button",{className:"text-xs border rounded-b px-2",disabled:t===s.length-1,onClick:e=>{e.stopPropagation(),j(t,t+1)},children:"▼"})]})]})]},t)})})}),(0,n.jsx)("div",{className:"p-3 border-t bg-gray-50 text-xs text-gray-500",children:f?"Last saved: ".concat(f.toLocaleString()):"Not saved yet"})]}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col gap-3",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsx)("div",{className:"text-lg font-semibold",children:"Survey editor"}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("button",{className:"px-3 py-1.5 border rounded-xl",onClick:()=>p(e=>!e),children:h?"Hide preview":"Show preview"}),(0,n.jsx)("button",{className:"px-3 py-1.5 border rounded-xl",onClick:()=>{e&&(a(Array.isArray(null==e?void 0:e.survey)?e.survey.map(y):[]),i(0),x(""))},children:"Discard"}),(0,n.jsx)("button",{className:"px-3 py-1.5 rounded-xl text-white bg-indigo-600 disabled:opacity-50",disabled:!g||d,onClick:w,children:d?"Saving…":"Save"})]})]}),!g&&(0,n.jsxs)("div",{className:"border rounded-xl p-3 text-sm bg-amber-50 border-amber-200 text-amber-800",children:[(0,n.jsx)("div",{className:"font-medium mb-1",children:"Please fix the following:"}),(0,n.jsx)("ul",{className:"list-disc ml-5",children:v.errors.map((e,t)=>(0,n.jsx)("li",{children:e},t))})]}),m&&(0,n.jsx)("div",{className:"border rounded-xl p-3 text-sm bg-red-50 border-red-200 text-red-800",children:m}),s[r]?(0,n.jsx)(L,{field:s[r],onChange:e=>N(r,e),onChangeOption:e=>N(r,{options:e})}):(0,n.jsx)("div",{className:"border rounded-2xl p-6 text-sm text-gray-500",children:"Select or add a field to edit."}),h&&(0,n.jsxs)("div",{className:"border rounded-2xl p-4",children:[(0,n.jsx)("div",{className:"text-sm font-medium mb-3",children:"Live preview"}),(0,n.jsx)(F,{fields:s})]})]})]})}function L(e){let{field:t,onChange:s,onChangeOption:l}=e;return(0,n.jsxs)("div",{className:"border rounded-2xl p-4",children:[(0,n.jsx)("div",{className:"text-sm font-semibold mb-4",children:"Field settings"}),(0,n.jsxs)("div",{className:"mb-3",children:[(0,n.jsx)("label",{className:"block text-xs text-gray-700 mb-1",children:"Label (stored as `name`)"}),(0,n.jsx)("input",{className:"w-full border rounded-lg px-3 py-2",value:t.name,onChange:e=>s({name:e.target.value}),placeholder:"e.g., age"})]}),(0,n.jsxs)("div",{className:"mb-3",children:[(0,n.jsx)("label",{className:"block text-xs text-gray-700 mb-1",children:"Type"}),(0,n.jsx)("select",{className:"w-full border rounded-lg px-3 py-2",value:t.type,onChange:e=>s({type:e.target.value}),children:T.map(e=>(0,n.jsx)("option",{value:e,children:e},e))})]}),"select"===t.type&&(0,n.jsx)(D,{options:t.options||[],onChange:l})]})}function D(e){let{options:t,onChange:s}=e,l=(e,n)=>{let l=[...t],[a]=l.splice(e,1);l.splice(n,0,a),s(l)};return(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,n.jsx)("label",{className:"block text-xs text-gray-700",children:"Options"}),(0,n.jsx)("button",{className:"text-sm px-2 py-1 border rounded-lg",onClick:()=>s([...t||[],""]),children:"Add option"})]}),(null==t?void 0:t.length)?(0,n.jsx)("ul",{className:"space-y-2",children:t.map((e,a)=>(0,n.jsxs)("li",{className:"flex items-center gap-2",children:[(0,n.jsx)("input",{className:"flex-1 border rounded-lg px-3 py-2",value:e,onChange:e=>((e,n)=>{let l=[...t];l[e]=n,s(l)})(a,e.target.value),placeholder:"Option ".concat(a+1)}),(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)("button",{className:"text-xs border rounded-t px-2",disabled:0===a,onClick:()=>l(a,a-1),children:"▲"}),(0,n.jsx)("button",{className:"text-xs border rounded-b px-2",disabled:a===t.length-1,onClick:()=>l(a,a+1),children:"▼"})]}),(0,n.jsx)("button",{className:"text-xs px-2 py-1 border rounded-lg",onClick:()=>s(t.filter((e,t)=>t!==a)),children:"Delete"})]},a))}):(0,n.jsxs)("div",{className:"text-xs text-gray-500",children:["No options yet. Click ",(0,n.jsx)("b",{children:"Add option"}),"."]})]})}function F(e){let{fields:t}=e;return(0,n.jsx)("div",{className:"space-y-3",children:t.map((e,t)=>(0,n.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,n.jsx)("label",{className:"text-sm text-gray-700",children:e.name}),"select"===e.type?(0,n.jsx)("select",{className:"border rounded-lg px-3 py-2",children:(e.options||[]).map((e,t)=>(0,n.jsx)("option",{value:e,children:e},t))}):(0,n.jsx)("input",{className:"border rounded-lg px-3 py-2",type:e.type})]},t))})}function P(e){if("select"!==e.type){let{options:t,...s}=e;return s}let t=(e.options||[]).map(e=>"".concat(e).trim()).filter(Boolean);return{...e,options:t}}let B=(0,S.hd)("/api/route-endpoints");function I(){let[e,t]=(0,l.useState)([]),[s,a]=(0,l.useState)(0),[r,i]=(0,l.useState)(!0),[o,c]=(0,l.useState)(!1),[d,u]=(0,l.useState)("");(0,l.useEffect)(()=>{i(!0),fetch(B,{credentials:"include"}).then(e=>{if(!e.ok)throw Error("Failed to load config (".concat(e.status,")"));return e.json()}).then(e=>{t(Array.isArray(e.instructions)?e.instructions:[]),u("")}).catch(e=>u(e.message)).finally(()=>i(!1))},[]);let m=(e,s)=>{t(t=>t.map((t,n)=>n===e?{...t,...s}:t))},x=async()=>{c(!0),u("");try{let t=await fetch(B,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({instructions:e})});if(!t.ok)throw Error("Failed to save (".concat(t.status,")"))}catch(e){u(e.message||String(e))}finally{c(!1)}};return r?(0,n.jsx)("div",{className:"p-6 text-sm text-gray-600",children:"Loading…"}):(0,n.jsxs)("div",{className:"flex h-[calc(100vh-2rem)] gap-4",children:[(0,n.jsxs)("div",{className:"w-64 shrink-0 border rounded-2xl overflow-hidden flex flex-col",children:[(0,n.jsxs)("div",{className:"px-4 py-3 border-b bg-gray-50 flex items-center justify-between",children:[(0,n.jsx)("h2",{className:"font-semibold",children:"Steps"}),(0,n.jsx)("button",{onClick:()=>{t(e=>[...e,{title:"",lines:[""],example:""}]),a(e.length)},className:"text-sm px-2 py-1 rounded-lg border",children:"Add"})]}),(0,n.jsx)("div",{className:"flex-1 overflow-auto",children:0===e.length?(0,n.jsx)("div",{className:"p-4 text-sm text-gray-500",children:"No steps yet."}):(0,n.jsx)("ul",{className:"divide-y",children:e.map((e,t)=>(0,n.jsx)("li",{className:"px-3 py-2 cursor-pointer ".concat(s===t?"bg-indigo-50":"hover:bg-gray-50"),onClick:()=>a(t),children:(0,n.jsx)("div",{className:"truncate text-sm font-medium",children:e.title||"Step ".concat(t+1)})},t))})})]}),(0,n.jsxs)("div",{className:"flex-1 flex flex-col gap-3",children:[d&&(0,n.jsx)("div",{className:"border rounded-xl p-3 text-sm bg-red-50 border-red-200 text-red-800",children:d}),e[s]?(0,n.jsxs)("div",{className:"flex-1 overflow-auto space-y-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Title"}),(0,n.jsx)("input",{type:"text",value:e[s].title,onChange:e=>m(s,{title:e.target.value}),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Lines"}),(0,n.jsx)("textarea",{value:(e[s].lines||[]).join("\n"),onChange:e=>{m(s,{lines:e.target.value.split("\n")})},className:"w-full border rounded px-2 py-1 text-sm h-32"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Example (optional)"}),(0,n.jsx)("input",{type:"text",value:e[s].example||"",onChange:e=>m(s,{example:e.target.value}),className:"w-full border rounded px-2 py-1 text-sm"})]}),(0,n.jsx)("button",{onClick:()=>{t(e=>e.filter((e,t)=>t!==s)),a(e=>e>s?e-1:Math.max(0,e-(e===s)))},className:"text-sm px-3 py-1 border rounded-lg text-red-600",children:"Delete step"})]}):(0,n.jsx)("div",{className:"text-sm text-gray-500",children:"No step selected."}),(0,n.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,n.jsx)("button",{onClick:()=>{i(!0),fetch(B,{credentials:"include"}).then(e=>e.json()).then(e=>t(Array.isArray(e.instructions)?e.instructions:[])).finally(()=>i(!1))},className:"px-3 py-1.5 border rounded-xl",children:"Discard"}),(0,n.jsx)("button",{onClick:x,disabled:o,className:"px-3 py-1.5 rounded-xl text-white bg-indigo-600 disabled:opacity-50",children:o?"Saving…":"Save"})]})]})]})}let z=(0,S.hd)("/api/route-endpoints");function M(){let[e,t]=(0,l.useState)(""),[s,a]=(0,l.useState)(""),[r,i]=(0,l.useState)(!0),[o,c]=(0,l.useState)(!1),[d,u]=(0,l.useState)("");(0,l.useEffect)(()=>{i(!0),fetch(z,{credentials:"include"}).then(e=>{if(!e.ok)throw Error("Failed to load config (".concat(e.status,")"));return e.json()}).then(e=>{t(e.consentText||"");let s=e.scenarioText||{line1:"",line2:"",line3:""};a([s.line1,s.line2,s.line3].filter(Boolean).join("\n")),u("")}).catch(e=>u(e.message)).finally(()=>i(!1))},[]);let m=async()=>{c(!0),u("");try{let t=s.split("\n"),n={line1:t[0]||"",line2:t[1]||"",line3:t[2]||""},l=await fetch(z,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({consentText:e,scenarioText:n})});if(!l.ok)throw Error("Failed to save (".concat(l.status,")"))}catch(e){u(e.message||String(e))}finally{c(!1)}};return r?(0,n.jsx)("div",{className:"p-6 text-sm text-gray-600",children:"Loading…"}):(0,n.jsxs)("div",{className:"max-w-3xl space-y-6",children:[d&&(0,n.jsx)("div",{className:"border rounded-xl p-3 text-sm bg-red-50 border-red-200 text-red-800",children:d}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1",children:"Consent text"}),(0,n.jsx)("textarea",{value:e,onChange:e=>t(e.target.value),className:"w-full border rounded px-2 py-1 text-sm h-48"})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{className:"text-lg font-semibold mb-1",children:"Scenario text"}),(0,n.jsx)("textarea",{value:s,onChange:e=>a(e.target.value),className:"w-full border rounded px-2 py-1 text-sm h-32"})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)("button",{onClick:()=>{i(!0),fetch(z,{credentials:"include"}).then(e=>e.json()).then(e=>{t(e.consentText||"");let s=e.scenarioText||{line1:"",line2:"",line3:""};a([s.line1,s.line2,s.line3].filter(Boolean).join("\n"))}).finally(()=>i(!1))},className:"px-3 py-1.5 border rounded-xl",children:"Discard"}),(0,n.jsx)("button",{onClick:m,disabled:o,className:"px-3 py-1.5 rounded-xl text-white bg-indigo-600 disabled:opacity-50",children:o?"Saving…":"Save"})]})]})}let R=(0,l.createContext)(null),Z=()=>{let e=(0,l.useContext)(R);if(!e)throw Error("useConfig must be used within <AdminApp>");return e},H=(0,S.hd)("/api/route-endpoints");function U(){let[e,t]=(0,l.useState)(null),[s,a]=(0,l.useState)(!0),[o,c]=(0,l.useState)(""),[d,u]=(0,l.useState)(!1),[m,x]=(0,l.useState)(!1),[h,p]=(0,l.useState)(null);(0,l.useEffect)(()=>{f()},[]),(0,l.useEffect)(()=>{let e=e=>{d&&(e.preventDefault(),e.returnValue="")};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)},[d]);let f=async()=>{a(!0);try{let e=await fetch(H,{credentials:"include"});if(!e.ok)throw Error("Failed to load config (".concat(e.status,")"));let s=await e.json();t(s),c("")}catch(e){c(e.message||String(e))}finally{a(!1)}},b=async()=>{if(e){x(!0),c("");try{let t=function(e){let t=[],s=Object.entries("object"==typeof(null==e?void 0:e.scenarios)&&null!==e.scenarios?e.scenarios:{}),n=(null==e?void 0:e.settings)||{};0===s.length&&t.push("At least one scenario must be defined");let l=n.number_of_scenarios;(!Number.isInteger(l)||l<1||l>s.length)&&t.push("number_of_scenarios must be between 1 and the number of scenarios"),"boolean"!=typeof n.scenario_shuffle&&t.push("scenario_shuffle must be a boolean");let a=e=>Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&e[0]>=-90&&e[0]<=90&&e[1]>=-180&&e[1]<=180,r=e=>Array.isArray(e)&&e.length>0&&e.every(a),i=e=>"string"==typeof e&&""!==e.trim();return s.forEach((e,s)=>{let[n,l]=e,a="".concat(n,": "),o=Array.isArray(null==l?void 0:l.choice_list)?l.choice_list:[];!l.randomly_preselect_route&&o.filter(e=>e.preselected).length>1&&t.push(a+"cannot have multiple preselected routes when randomly_preselect_route=false"),r(null==l?void 0:l.start)||t.push(a+"start must contain valid coordinates"),r(null==l?void 0:l.end)||t.push(a+"end must contain valid coordinates");let c=Array.isArray(null==l?void 0:l.default_route_time)?l.default_route_time:[];(0===c.length||c.some(e=>!Number.isInteger(e)||e<=0))&&t.push(a+"default_route_time must contain positive integers"),i(null==l?void 0:l.scenario_name)||t.push(a+"scenario_name must be a non-empty string"),i(null==l?void 0:l.value_name)||t.push(a+"value_name must be a non-empty string"),i(null==l?void 0:l.description)||t.push(a+"description must be a non-empty string"),0===o.length&&t.push(a+"Alternative routes must not be empty"),o.forEach((e,s)=>{let n="".concat(a,"Alternative route ").concat(s+1,": ");r(null==e?void 0:e.middle_point)||t.push(n+"middle_point must contain valid coordinates");let l=Array.isArray(null==e?void 0:e.tts)?e.tts:[];(0===l.length||l.some(e=>!Number.isInteger(e)||e<0))&&t.push(n+"tts must contain non-negative integers"),"boolean"!=typeof(null==e?void 0:e.preselected)&&t.push(n+"preselected must be boolean")})}),{ok:0===t.length,errors:t}}(e);if(!t.ok)throw Error(t.errors.join("; "));let{start:s,end:n,scenarios:l,settings:a}=e||{},r={};void 0!==s&&(r.start=s),void 0!==n&&(r.end=n),void 0!==l&&(r.scenarios=l),void 0!==a&&(r.settings=a);let i=await fetch(H,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(r)});if(!i.ok)throw Error("Failed to save (".concat(i.status,")"));await f(),u(!1),p(new Date)}catch(e){c(e.message||String(e))}finally{x(!1)}}},y=async()=>{await f(),u(!1)},v=(0,l.useMemo)(()=>({config:e,setConfig:t,setDirty:u}),[e]),g=(0,i.useRouter)(),j=(0,i.usePathname)().split("/").pop(),N=["scenarios","survey","instructions","texts"];(0,l.useEffect)(()=>{j&&N.includes(j)||g.replace("/admin/scenarios")},[j,g]);let w=e=>"px-2 py-1 rounded ".concat(j===e?"bg-white border":"hover:underline"),A="scenarios"===j;return s?(0,n.jsx)("div",{className:"p-6 text-sm text-gray-600",children:"Loading…"}):(0,n.jsxs)(R.Provider,{value:v,children:[(0,n.jsxs)("header",{className:"flex items-center justify-between p-4 border-b bg-gray-50",children:[(0,n.jsxs)("nav",{className:"flex gap-4",children:[(0,n.jsx)(r(),{href:"/admin/scenarios",className:w("scenarios"),children:"Scenarios"}),(0,n.jsx)(r(),{href:"/admin/survey",className:w("survey"),children:"Survey"}),(0,n.jsx)(r(),{href:"/admin/instructions",className:w("instructions"),children:"Instructions"}),(0,n.jsx)(r(),{href:"/admin/texts",className:w("texts"),children:"Texts"})]}),(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[A&&d&&(0,n.jsx)("span",{className:"text-xs text-amber-700 bg-amber-100 px-2 py-0.5 rounded",children:"Unsaved changes"}),A&&h&&!d&&(0,n.jsxs)("span",{className:"text-xs text-gray-500",children:["Last saved: ",h.toLocaleString()]}),A&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("button",{onClick:y,className:"border px-3 py-1 rounded",children:"Discard"}),(0,n.jsx)("button",{onClick:b,disabled:!d||m,className:"bg-indigo-600 text-white px-3 py-1 rounded disabled:opacity-50",children:m?"Saving…":"Save"})]}),(0,n.jsx)("button",{onClick:()=>{window.alert("Authentication now uses a browser popup. Close this tab or clear the site's saved credentials to sign out.")},className:"border px-3 py-1 rounded",children:"Logout"})]})]}),o&&(0,n.jsx)("div",{className:"m-4 border rounded p-3 text-sm bg-red-50 border-red-200 text-red-800",children:o}),(0,n.jsxs)("main",{className:"p-4",children:["scenarios"===j&&(0,n.jsx)(k,{}),"survey"===j&&(0,n.jsx)(O,{}),"instructions"===j&&(0,n.jsx)(I,{}),"texts"===j&&(0,n.jsx)(M,{})]})]})}},4597:(e,t,s)=>{s.d(t,{K:()=>n});async function n(e,t){if(!Array.isArray(e)||e.length<2)return null;let s=e.map(e=>{let[t,s]=e;return"".concat(s,",").concat(t)}).join(";");try{var n,l,a;let e=await fetch("https://router.project-osrm.org/route/v1/driving/".concat(s,"?overview=full&geometries=geojson"),{signal:t});if(!e.ok)return null;let r=await e.json(),i=null==r||null==(a=r.routes)||null==(l=a[0])||null==(n=l.geometry)?void 0:n.coordinates;if(!i)return null;return i.map(e=>{let[t,s]=e;return[s,t]})}catch(e){return null}}},5078:(e,t,s)=>{s.d(t,{A:()=>r,v:()=>i});var n=s(5027),l=s.n(n);let a=(e,t)=>l().divIcon({className:"",iconSize:[40,40],iconAnchor:[20,40],html:'\n      <svg width="40" height="40" viewBox="0 0 24 24">\n        <path fill="'.concat(e,'" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>\n        <text x="12" y="16" text-anchor="middle" font-size="10" font-family="Arial" font-weight="bold" fill="#fff">').concat(t,"</text>\n      </svg>\n    ")}),r=a("#34A853","S"),i=a("#EA4335","E")}}]);